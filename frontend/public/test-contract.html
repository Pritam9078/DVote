<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DVote Contract Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        input, textarea { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üß™ DVote Contract Test</h1>
    <p>Test direct interaction with your DAO contract to diagnose proposal creation issues.</p>
    
    <div class="result" id="status">
        üì° Connect your wallet and we'll test the contract interaction...
    </div>

    <div>
        <h3>üìù Test Proposal Creation</h3>
        <input type="text" id="title" placeholder="Proposal Title" value="Test Frontend Proposal">
        <textarea id="description" placeholder="Description" rows="3">Test proposal created from frontend test page</textarea>
        <input type="text" id="target" placeholder="Target Address (use 0x0000... for simple proposal)" value="0x0000000000000000000000000000000000000000">
        <input type="number" id="value" placeholder="Value in ETH" value="0" step="0.001">
        <br>
        <button onclick="connectWallet()">üîó Connect Wallet</button>
        <button onclick="checkBalances()">üí∞ Check Balances</button>
        <button onclick="createProposal()">üìù Create Proposal</button>
        <button onclick="getProposals()">üìã Get Proposals</button>
    </div>

    <div class="result" id="results"></div>

    <script>
        let web3, account, daoContract, tokenContract;
        
        const DAO_ADDRESS = "0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0";
        const TOKEN_ADDRESS = "0x5FbDB2315678afecb367f032d93F642f64180aa3";
        
        // Minimal ABI for testing
        const DAO_ABI = [
            "function createProposal(string memory title, string memory descriptionCID, address target, uint256 value) external returns (uint256)",
            "function proposalCount() external view returns (uint256)",
            "function proposals(uint256) external view returns (tuple(uint256 id, address proposer, string title, string descriptionCID, uint256 snapshotBlock, uint256 startTime, uint256 endTime, uint8 state))",
            "function proposalThreshold() external view returns (uint256)",
            "function paused() external view returns (bool)"
        ];
        
        const TOKEN_ABI = [
            "function balanceOf(address owner) external view returns (uint256)",
            "function getVotes(address account) external view returns (uint256)"
        ];

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const className = type === 'error' ? 'error' : (type === 'success' ? 'success' : '');
            results.innerHTML += `<div class="result ${className}">${new Date().toLocaleTimeString()}: ${message}</div>`;
            results.scrollTop = results.scrollHeight;
        }

        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    log("‚ùå MetaMask not detected!", 'error');
                    return;
                }

                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                account = accounts[0];
                
                // Check network
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                const chainIdDecimal = parseInt(chainId, 16);
                
                log(`‚úÖ Connected: ${account}`);
                log(`üåê Network: ${chainIdDecimal} (${chainIdDecimal === 31337 ? 'Localhost' : 'Other'})`);
                
                if (chainIdDecimal !== 31337) {
                    log("‚ö†Ô∏è Please switch to localhost network (Chain ID: 31337)", 'error');
                }

                // Initialize contracts
                web3 = new Web3(window.ethereum);
                daoContract = new web3.eth.Contract(DAO_ABI, DAO_ADDRESS);
                tokenContract = new web3.eth.Contract(TOKEN_ABI, TOKEN_ADDRESS);
                
                document.getElementById('status').innerHTML = "‚úÖ Wallet connected! Ready for testing.";
                document.getElementById('status').className = "result success";
                
            } catch (error) {
                log(`‚ùå Connection failed: ${error.message}`, 'error');
            }
        }

        async function checkBalances() {
            try {
                if (!account) {
                    log("‚ùå Please connect wallet first", 'error');
                    return;
                }

                log("üîç Checking balances and permissions...");
                
                const balance = await tokenContract.methods.balanceOf(account).call();
                const votingPower = await tokenContract.methods.getVotes(account).call();
                const threshold = await daoContract.methods.proposalThreshold().call();
                const proposalCount = await daoContract.methods.proposalCount().call();
                const isPaused = await daoContract.methods.paused().call();
                
                log(`üí∞ Token Balance: ${web3.utils.fromWei(balance, 'ether')} DVT`);
                log(`üó≥Ô∏è Voting Power: ${web3.utils.fromWei(votingPower, 'ether')} DVT`);
                log(`üìä Proposal Threshold: ${web3.utils.fromWei(threshold, 'ether')} DVT`);
                log(`üìã Total Proposals: ${proposalCount}`);
                log(`‚è∏Ô∏è Contract Paused: ${isPaused}`);
                
                const canCreateProposal = BigInt(votingPower) >= BigInt(threshold) && !isPaused;
                log(`‚úÖ Can Create Proposals: ${canCreateProposal}`, canCreateProposal ? 'success' : 'error');
                
            } catch (error) {
                log(`‚ùå Balance check failed: ${error.message}`, 'error');
            }
        }

        async function createProposal() {
            try {
                if (!account || !daoContract) {
                    log("‚ùå Please connect wallet first", 'error');
                    return;
                }

                const title = document.getElementById('title').value;
                const description = document.getElementById('description').value;
                const target = document.getElementById('target').value;
                const value = document.getElementById('value').value;
                
                if (!title || !description) {
                    log("‚ùå Please fill in title and description", 'error');
                    return;
                }

                log("üöÄ Creating proposal...");
                log(`üìù Title: ${title}`);
                log(`üìÑ Description: ${description}`);
                log(`üéØ Target: ${target}`);
                log(`üí∞ Value: ${value} ETH`);

                const valueWei = web3.utils.toWei(value.toString(), 'ether');
                
                // Estimate gas first
                const gasEstimate = await daoContract.methods
                    .createProposal(title, description, target, valueWei)
                    .estimateGas({ from: account });
                
                log(`‚õΩ Estimated Gas: ${gasEstimate}`);
                
                // Send transaction
                const tx = await daoContract.methods
                    .createProposal(title, description, target, valueWei)
                    .send({ 
                        from: account,
                        gas: Math.floor(gasEstimate * 1.2), // Add 20% buffer
                        gasPrice: await web3.eth.getGasPrice()
                    });

                log(`‚úÖ Proposal created! Transaction: ${tx.transactionHash}`, 'success');
                log(`üì¶ Block: ${tx.blockNumber}`);
                log(`‚õΩ Gas used: ${tx.gasUsed}`);
                
                // Get the new proposal count
                setTimeout(getProposals, 2000);
                
            } catch (error) {
                log(`‚ùå Proposal creation failed: ${error.message}`, 'error');
                
                if (error.message.includes('User denied')) {
                    log("üí° User rejected the transaction in MetaMask", 'error');
                } else if (error.message.includes('insufficient funds')) {
                    log("üí° Insufficient ETH for gas fees", 'error');
                } else if (error.message.includes('execution reverted')) {
                    log("üí° Smart contract rejected the transaction - check requirements", 'error');
                }
            }
        }

        async function getProposals() {
            try {
                if (!daoContract) {
                    log("‚ùå Please connect wallet first", 'error');
                    return;
                }

                const count = await daoContract.methods.proposalCount().call();
                log(`üìä Total proposals: ${count}`);
                
                if (count > 0) {
                    for (let i = 1; i <= Math.min(count, 5); i++) {
                        const proposal = await daoContract.methods.proposals(i).call();
                        log(`üìã Proposal ${i}: "${proposal.title}" by ${proposal.proposer}`);
                    }
                }
                
            } catch (error) {
                log(`‚ùå Failed to get proposals: ${error.message}`, 'error');
            }
        }

        // Auto-connect if already connected
        window.addEventListener('load', async () => {
            if (window.ethereum && window.ethereum.selectedAddress) {
                await connectWallet();
            }
        });
    </script>
    
    <!-- Include Web3.js -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.2/dist/web3.min.js"></script>
</body>
</html>
